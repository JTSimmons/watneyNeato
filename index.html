<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Watney-2 Rover</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="js/lib/adapter.js"></script>
    <script src="js/common.js"></script>
    <script src="js/main_rws.js"></script>
    <script>
        var up = false;
        var down = false;
        var left = false;
        var right = false;
        var turbo = false;
        var lookUp = false;
        var lookDown = false;
        
        var lastBearing = -1;
        var lastSpeed = -1;
        var lastLook = 0;
        
        function sendKeys() {
            var bearing = -1;
            var speed = 0;
            var look = 0

            if (turbo) {
                speed = 1;
            }
            else {
                speed = 0.5;
            }
            
            if (up) {
                if (left) {
                    bearing = 135;
                }
                else if (right) {
                    bearing = 45;
                }
                else {
                    bearing = 90;
                }
            }
            else if (down) {
                if (left) {
                    bearing = 225;
                }
                else if (right) {
                    bearing = 315;
                }
                else {
                    bearing = 270;
                }
            }
            else if (left) {
                bearing = 180;
            }
            else if (right) {
                bearing = 0;
            }

            if (lookUp) {
                look = 1;
            }
            else if (lookDown) {
                look = -1;
            }

            if (lastBearing != bearing ||  lastSpeed != speed || lastLook != look) {
                lastBearing = bearing;
                lastSpeed = speed;
                lastLook = look;
                var commandObj = {
                    'bearing': bearing,
                    'speed': speed,
                    'look': look
                };
            
                $.ajax({
                      url:'/sendCommand',
                      type:"POST",
                      data:JSON.stringify(commandObj),
                      contentType:"application/json; charset=utf-8",
                      dataType:"json"
                });
            }
            
            
        }
        
        $(document).ready(function() {
            $("#inputControl").keydown(function(event) {
                event.preventDefault();

                if (event.shiftKey) {
                    turbo = true;
                }

                if (event.keyCode == 38) {
                    up = true;
                }
                else if (event.keyCode == 40) {
                    down = true;
                }
                else if(event.keyCode == 37) {
                    left = true;
                }
                else if(event.keyCode == 39) {
                    right = true;
                }
                else if (event.keyCode == 65) {
                    lookDown = true;
                }
                else if(event.keyCode == 90) {
                    lookUp = true;
                }
                
                sendKeys();
            });

            $("#inputControl").keyup(function(event) {
                event.preventDefault();

                if (!event.shiftKey) {
                    turbo = false;
                }
                
                if (event.keyCode == 38) {
                    up = false;
                }
                else if (event.keyCode == 40) {
                    down = false;
                }
                else if(event.keyCode == 37) {
                    left = false;
                }
                else if(event.keyCode == 39) {
                    right = false;
                }
                else if (event.keyCode == 65) {
                    lookDown = false;
                }
                else if(event.keyCode == 90) {
                    lookUp = false;
                }

                sendKeys();
            });

            $("#inputControl").focus(function(event) {
                 $(this).attr("placeholder", "Use Arrow Keys");
            });

            $("#inputControl").focusout(function(event) {
                 $(this).attr("placeholder", "Click Here");
            });

            doConnect();

        });

</script>
    <style>
    #vid {
        object-fit: contain;
    }

    input::placeholder {
        text-align: center;
        vertical-align: middle;
        font-size: 1em
    }
}
    </style>
</head>

<body style="margin 0; background-color: black">
<video style="width: auto; height: calc(100vh - 32px); position: fixed; top: 0; left: 50%; transform: translateX(-50%); " id="vid" autoplay ></video>
<input id="inputControl" style="position: fixed; bottom: 0; left: 0; height: 30px; width: 100%" placeholder="Click Here" />

</body>
</html>